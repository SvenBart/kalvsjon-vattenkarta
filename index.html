<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalvsjön Vattenkvalitet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        #header p {
            font-size: 14px;
            opacity: 0.9;
        }
        #map {
            flex: 1;
            width: 100%;
        }
        #controls {
            position: absolute;
            top: 80px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 250px;
        }
        #controls h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #2c3e50;
        }
        #dateSelector {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 14px;
        }
        #legend {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        #legend h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            margin: 15px;
            font-size: 14px;
            line-height: 1.6;
        }
        .popup-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .popup-date {
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .popup-value {
            margin: 5px 0;
        }
        .popup-label {
            font-weight: 600;
            color: #555;
        }
        #file-upload {
            position: absolute;
            bottom: 20px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
        }
        #file-upload h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #2c3e50;
        }
        .file-input-group {
            margin-bottom: 10px;
        }
        .file-input-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: #555;
        }
        .file-input-group input {
            width: 100%;
            padding: 5px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #status {
            margin-top: 10px;
            padding: 8px;
            background: #e8f5e9;
            border-radius: 4px;
            font-size: 12px;
            color: #2e7d32;
            display: none;
        }
        .status-error {
            background: #ffebee !important;
            color: #c62828 !important;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Kalvsjön Vattenkvalitet</h1>
        <p>Färgtalsmätningar - Svenljunga & Falkenberg</p>
    </div>
    
    <div id="map"></div>
    
    <div id="controls">
        <h3>Välj mättillfälle</h3>
        <select id="dateSelector">
            <option value="">Laddar data...</option>
        </select>
        
        <div id="legend">
            <h4>Färgtal (mg Pt/l)</h4>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #2ecc71;"></div>
                <span>&lt; 77</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f1c40f;"></div>
                <span>77-150</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e74c3c;"></div>
                <span>151-250</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #8b4513;"></div>
                <span>251-350</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #000000;"></div>
                <span>&gt; 350</span>
            </div>
        </div>
    </div>

    <div id="file-upload">
        <h4>Ladda upp CSV-filer</h4>
        <div class="file-input-group">
            <label>Punkter (punkter.csv):</label>
            <input type="file" id="punkterFile" accept=".csv">
        </div>
        <div class="file-input-group">
            <label>Mätningar (matningar.csv):</label>
            <input type="file" id="matningarFile" accept=".csv">
        </div>
        <div id="status"></div>
    </div>

    <script>
        (function() {
            proj4.defs("EPSG:3006", "+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");

            function sweref99ToWgs84(n, e) {
                return proj4('EPSG:3006', 'EPSG:4326', [e, n]);
            }

            function getColor(fargtal) {
                if (fargtal < 77) return '#2ecc71';
                if (fargtal < 151) return '#f1c40f';
                if (fargtal < 251) return '#e74c3c';
                if (fargtal < 351) return '#8b4513';
                return '#000000';  // Riktig svart färg
            }

            const map = L.map('map').setView([57.175, 13.036], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            let punkter = [];
            let matningar = [];
            const markers = L.layerGroup().addTo(map);

            // Ingen exempel-data - kartan startar tom
            const exempelPunkter = `Punkt_ID,Platsnamn,N,E`;
            const exempelMatningar = `Punkt_ID,Datum,Färgtal_1,Färgtal_2,Färgtal_3,Färgtal_4,Färgtal_5,Färgtal_6,Färgtal_7,pH,Siktdjup`;

            function parseMatningar(data) {
                const result = [];
                
                data.forEach(row => {
                    console.log('Behandlar rad:', row);
                    const fargtalValues = [];
                    const phValues = [];
                    
                    for (let key in row) {
                        if (key.startsWith('Färgtal_') && row[key] && row[key].trim() !== '') {
                            console.log('Hittade färgtal i kolumn', key, ':', row[key]);
                            const val = parseFloat(row[key]);
                            if (!isNaN(val)) fargtalValues.push(val);
                        }
                    }
                    
                    console.log('Färgtalsvärden för', row.Punkt_ID, ':', fargtalValues);
                    
                    if (row.pH && row.pH.trim() !== '') {
                        const val = parseFloat(row.pH);
                        if (!isNaN(val)) phValues.push(val);
                    }
                    
                    let siktdjup = null;
                    if (row.Siktdjup && row.Siktdjup.trim() !== '') {
                        const val = parseFloat(row.Siktdjup);
                        if (!isNaN(val)) siktdjup = val.toFixed(1);
                    }
                    
                    const fargtalMedel = fargtalValues.length > 0 
                        ? Math.round(fargtalValues.reduce((a, b) => a + b, 0) / fargtalValues.length)
                        : null;
                    
                    const phMedel = phValues.length > 0 
                        ? phValues[0].toFixed(2)
                        : null;
                    
                    if (fargtalMedel !== null) {
                        result.push({
                            Punkt_ID: row.Punkt_ID,
                            Datum: row.Datum,
                            Fargtal: fargtalMedel,
                            pH: phMedel,
                            Siktdjup: siktdjup
                        });
                    } else {
                        console.log('Hoppade över rad (inget färgtal):', row.Punkt_ID);
                    }
                });
                
                return result;
            }

            function updateMap(selectedDate) {
                markers.clearLayers();

                const filteredData = matningar.filter(m => m.Datum === selectedDate);

                filteredData.forEach(matning => {
                    const punkt = punkter.find(p => p.Punkt_ID === matning.Punkt_ID);
                    if (!punkt) return;

                    const [lon, lat] = sweref99ToWgs84(parseFloat(punkt.N), parseFloat(punkt.E));
                    const color = getColor(matning.Fargtal);

                    const marker = L.circleMarker([lat, lon], {
                        radius: 10,
                        fillColor: color,
                        color: '#333',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    });

                    let popupHTML = '<div class="popup-title">📍 ' + punkt.Platsnamn + ' (' + punkt.Punkt_ID + ')</div>';
                    popupHTML += '<div class="popup-date">' + matning.Datum + '</div>';
                    popupHTML += '<div class="popup-value"><span class="popup-label">Färgtal:</span> ' + matning.Fargtal + ' mg Pt/l</div>';
                    
                    if (matning.pH) {
                        popupHTML += '<div class="popup-value"><span class="popup-label">pH:</span> ' + matning.pH + '</div>';
                    }
                    
                    if (matning.Siktdjup) {
                        popupHTML += '<div class="popup-value"><span class="popup-label">Siktdjup:</span> ' + matning.Siktdjup + ' m</div>';
                    }

                    marker.bindPopup(popupHTML);
                    marker.addTo(markers);
                });
            }

            function updateDateSelector() {
                const dates = [...new Set(matningar.map(m => m.Datum))].sort();
                const selector = document.getElementById('dateSelector');
                selector.innerHTML = dates.map(date => '<option value="' + date + '">' + date + '</option>').join('');
                
                if (dates.length > 0) {
                    updateMap(dates[dates.length - 1]);
                }
            }

            function loadData(punkterCsv, matningarCsv) {
                // Detektera om det är semikolon eller komma
                const punkterDelimiter = punkterCsv.includes(';') ? ';' : ',';
                const matningarDelimiter = matningarCsv.includes(';') ? ';' : ',';
                
                Papa.parse(punkterCsv, {
                    header: true,
                    delimiter: punkterDelimiter,
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log('Punkter parsed:', results.data);
                        punkter = results.data.filter(row => row.Punkt_ID && row.Punkt_ID.trim() !== '');
                        console.log('Filtrerade punkter:', punkter);
                        
                        Papa.parse(matningarCsv, {
                            header: true,
                            delimiter: matningarDelimiter,
                            skipEmptyLines: true,
                            complete: function(results) {
                                console.log('Mätningar parsed:', results.data);
                                const rawData = results.data.filter(row => row.Punkt_ID && row.Punkt_ID.trim() !== '' && row.Datum && row.Datum.trim() !== '');
                                console.log('Filtrerade mätningar:', rawData);
                                matningar = parseMatningar(rawData);
                                console.log('Beräknade mätningar:', matningar);
                                updateDateSelector();
                                showStatus('Data laddad! Visar ' + punkter.length + ' punkter med ' + matningar.length + ' mättillfällen.');
                            },
                            error: function(error) {
                                console.error('Fel vid parsing av mätningar:', error);
                                showStatus('Fel vid läsning av mätningar: ' + error.message, true);
                            }
                        });
                    },
                    error: function(error) {
                        console.error('Fel vid parsing av punkter:', error);
                        showStatus('Fel vid läsning av punkter: ' + error.message, true);
                    }
                });
            }

            let uploadedPunkter = null;
            let uploadedMatningar = null;

            function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    if (e.target.id === 'punkterFile') {
                        uploadedPunkter = event.target.result;
                        showStatus('Punkter laddad, väntar på mätningar...', false);
                    } else {
                        uploadedMatningar = event.target.result;
                        showStatus('Mätningar laddad, väntar på punkter...', false);
                    }

                    if (uploadedPunkter && uploadedMatningar) {
                        loadData(uploadedPunkter, uploadedMatningar);
                    }
                };
                reader.readAsText(file);
            }

            function showStatus(message, isError = false) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.style.display = 'block';
                if (isError) {
                    status.classList.add('status-error');
                } else {
                    status.classList.remove('status-error');
                }
                // Visa meddelandet längre
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }

            document.getElementById('punkterFile').addEventListener('change', handleFileUpload);
            document.getElementById('matningarFile').addEventListener('change', handleFileUpload);
            document.getElementById('dateSelector').addEventListener('change', function(e) {
                updateMap(e.target.value);
            });

            // Visa instruktion istället för att ladda exempel-data
            showStatus('Ladda upp dina CSV-filer för att börja!', false);
        })();
    </script>
</body>
</html>